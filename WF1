import telebot
import requests
import json
from iso3166 import countries

bot = telebot.TeleBot('6348104745:AAFf_BknzcuQCKL4rnQo8DEdIK6Tv1lB-hU')
API = 'a51f70434804eb3cc861b5377a808aa5'

@bot.message_handler(commands=['start'])
def main(message):
    bot.send_message(message.chat.id, '–ü—Ä–∏–≤–µ—Çüëã, –≤–≤–µ–¥–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞\n–∏ —è –ø–æ–∫–∞–∂—É —Ç–µ–±–µ —Ç–µ–∫—É—â–∏–µ –¥–∞–Ω–Ω—ã–µ –æ –ø–æ–≥–æ–¥–µ‚òÇÔ∏è, –∏ –ø—Ä–æ–≥–Ω–æ–∑üå°Ô∏è –Ω–∞ –±–ª–∏–∂–∞–π—à–∏–µ –¥–Ω–∏')

@bot.message_handler(content_types=['text'])
def get_forecast(message):
    city = message.text.strip().lower()
    res = requests.get(f'https://api.openweathermap.org/data/2.5/forecast?q={city}&appid={API}&units=metric')
    if res.status_code == 200:
        data = json.loads(res.text)["list"][:5]  # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –ø–µ—Ä–≤—ã–µ 5 –¥–Ω–µ–π
        forecast_data = []
        for day in data:
            date = day["dt_txt"].split()[0]  # –ü–æ–ª—É—á–∞–µ–º —Ç–æ–ª—å–∫–æ –¥–∞—Ç—É –±–µ–∑ –≤—Ä–µ–º–µ–Ω–∏
            temp_min = day["main"]["temp_min"]  # –ü–æ–ª—É—á–∞–µ–º –º–∏–Ω–∏–º–∞–ª—å–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É
            temp_max = day["main"]["temp_max"]  # –ü–æ–ª—É—á–∞–µ–º –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É
            weather = day["weather"][0]["main"]
            forecast_data.append((date, temp_min, temp_max, weather))  # –î–æ–±–∞–≤–ª—è–µ–º –≤ —Å–ø–∏—Å–æ–∫ –º–∏–Ω./–º–∞–∫—Å. —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã

        get_weather(message)  # –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â—É—é –ø–æ–≥–æ–¥—É
        response = '\n\n–ü—Ä–æ–≥–Ω–æ–∑ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã –Ω–∞ 5 –¥–Ω–µ–π:\n'
        for date, temp_min, temp_max, weather in forecast_data:
            response += f'–û—Ç {temp_min:.0f} ¬∞C –î–æ {temp_max:.0f} ¬∞C\n'
        bot.reply_to(message, response)
    else:
        bot.reply_to(message, '–ì–æ—Ä–æ–¥ —É–∫–∞–∑–∞–Ω –Ω–µ –≤–µ—Ä–Ω–æ')
def get_weather(message):
    city = message.text.strip().lower()
    res = requests.get(f'https://api.openweathermap.org/data/2.5/weather?q={city}&appid={API}&units=metric')
    if res.status_code == 200:
        data = json.loads(res.text)
        pressure = data["main"]["pressure"]
        humidity = data["main"]["humidity"]
        speed = data["wind"]["speed"]
        temp_min = data["main"]["temp_min"]
        temp_max = data["main"]["temp_max"]
        feels_like = data["main"]["feels_like"]
        weather = data["weather"][0]["main"]
        temp = data["main"]["temp"]

        country = data["sys"]["country"]  # –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä–∞–Ω–µ
        country_name = countries.get(country).name  # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω—ã
        region = data.get("name", "")  # –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏/–æ–±–ª–∞—Å—Ç–∏

        response = (f'{country_name}, {region} - –ü–æ–≥–æ–¥–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—èüòâ:\n–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {temp:.0f} ¬∞C\n–û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫: {feels_like:.0f} ¬∞C'
                              f'\n–°–µ–≥–æ–¥–Ω—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ –æ—Ç {temp_min:.0f} ¬∞C –¥–æ {temp_max:.0f} ¬∞C'
                              f'\n–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞: {speed:.0f} –º/—Å\n–í–ª–∞–∂–Ω–æ—Å—Ç—å: {humidity:.0f} %\n–î–∞–≤–ª–µ–Ω–∏–µ: {pressure * 0.75:.0f} –º–º —Ä—Ç —Å—Ç')
        if weather.lower() == 'rain':
            response += '\n–ò–¥—ë—Ç –¥–æ–∂–¥—å. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–æ–Ω—Ç‚òî'
            bot.reply_to(message, response)
            bot.send_message(message.chat.id, 'üåßÔ∏è')
        elif weather.lower() == 'clouds':
            response += '\n–û–±–ª–∞—á–Ω–æ, –±–µ–∑ –æ—Å–∞–¥–∫–æ–≤'
            bot.reply_to(message, response)
            bot.send_message(message.chat.id, '‚òÅÔ∏è')
        elif weather.lower() == 'clear':
            response += '\n–Ø—Å–Ω–æ–µ –Ω–µ–±–æ!'
            bot.reply_to(message, response)
            bot.send_message(message.chat.id, '‚òÄÔ∏è')
        elif weather.lower() == 'snow':
            response += '\n–ü–æ–π–¥—ë—Ç —Å–Ω–µ–≥!'
            bot.reply_to(message, response)
            bot.send_message(message.chat.id, '‚ùÑÔ∏è')

    else:
        bot.reply_to(message, '–ì–æ—Ä–æ–¥ —É–∫–∞–∑–∞–Ω –Ω–µ –≤–µ—Ä–Ω–æ')



bot.polling()
