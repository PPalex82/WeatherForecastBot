import telebot
import requests
import json
import pycountry
from iso3166 import countries

bot = telebot.TeleBot('6348104745:AAFf_BknzcuQCKL4rnQo8DEdIK6Tv1lB-hU')
API = 'a51f70434804eb3cc861b5377a808aa5'

@bot.message_handler(commands=['start'])
def main(message):
    bot.send_message(message.chat.id, '–ü—Ä–∏–≤–µ—Ç, –Ω–∞–ø–∏—à–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ —Å–≤–æ–µ–≥–æ –≥–æ—Ä–æ–¥–∞')

@bot.message_handler(content_types=['text'])
def get_weather(message):
    city = message.text.strip().lower()
    res = requests.get(f'https://api.openweathermap.org/data/2.5/weather?q={city}&appid={API}&units=metric')
    if res.status_code == 200:
        data = json.loads(res.text)
        pressure = data["main"]["pressure"]
        humidity = data["main"]["humidity"]
        speed = data["wind"]["speed"]
        temp_min = data["main"]["temp_min"]
        temp_max = data["main"]["temp_max"]
        feels_like = data["main"]["feels_like"]
        weather = data["weather"][0]["main"]
        temp = data["main"]["temp"]

        country = data["sys"]["country"]  # –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —Å—Ç—Ä–∞–Ω–µ
        country_name = countries.get(country).name  # –ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –Ω–∞–∑–≤–∞–Ω–∏—è —Å—Ç—Ä–∞–Ω—ã
        region = data.get("name", "")  # –î–æ–±–∞–≤–ª–µ–Ω–æ –ø–æ–ª—É—á–µ–Ω–∏–µ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –ø—Ä–æ–≤–∏–Ω—Ü–∏–∏/–æ–±–ª–∞—Å—Ç–∏

        response = (f'{country_name}, {region} - –ü–æ–≥–æ–¥–∞ –Ω–∞ —Å–µ–≥–æ–¥–Ω—èüòâ:\n–ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞: {temp:.0f} ¬∞C\n–û—â—É—â–∞–µ—Ç—Å—è –∫–∞–∫: {feels_like:.0f} ¬∞C'
                              f'\n–ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–µ–≥–æ–¥–Ω—è: {temp_min:.0f} ¬∞C\n–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ —Å–µ–≥–æ–¥–Ω—è: {temp_max:.0f} ¬∞C'
                              f'\n–°–∫–æ—Ä–æ—Å—Ç—å –≤–µ—Ç—Ä–∞: {speed:.0f} –∫–º/—á\n–í–ª–∞–∂–Ω–æ—Å—Ç—å: {humidity:.0f} %\n–î–∞–≤–ª–µ–Ω–∏–µ: {pressure * 0.75:.0f} –º–º —Ä—Ç —Å—Ç')
        if weather.lower() == 'rain':
            response += '\n–ò–¥—ë—Ç –¥–æ–∂–¥—å. –ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–æ–Ω—Ç‚òî'
            bot.reply_to(message, response)
            bot.send_message(message.chat.id, 'üåßÔ∏è')
        elif weather.lower() == 'clouds':
            response += '\n–û–±–ª–∞—á–Ω–æ, –±–µ–∑ –æ—Å–∞–¥–∫–æ–≤'
            bot.reply_to(message, response)
            bot.send_message(message.chat.id, '‚òÅÔ∏è')
        elif weather.lower() == 'clear':
            response += '\n–Ø—Å–Ω–æ–µ –Ω–µ–±–æ!'
            bot.reply_to(message, response)
            bot.send_message(message.chat.id, '‚òÄÔ∏è')
        elif weather.lower() == 'snow':
            response += '\n–ü–æ–π–¥—ë—Ç —Å–Ω–µ–≥!'
            bot.reply_to(message, response)
            bot.send_message(message.chat.id, '‚ùÑÔ∏è')
    else:
        bot.reply_to(message, '–ì–æ—Ä–æ–¥ —É–∫–∞–∑–∞–Ω –Ω–µ –≤–µ—Ä–Ω–æ')

bot.polling()
